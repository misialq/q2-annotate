{% extends 'base.html' %}

{% block head %}
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<link href="css/styles.css" rel="stylesheet"/>
<script type="text/javascript">
    // temporary hack to make it look good with Bootstrap 5
    removeBS3refs();
</script>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" rel="stylesheet"/>
{% endblock %}

{% block content %}
<script crossorigin="anonymous" integrity="sha256-9SEPo+fwJFpMUet/KACSwO+Z/dKMReF9q4zFhU/fT9M=" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<br>

<div class="row" style="justify-content: space-evenly; align-items: start;">
    <div class="row" style="margin-bottom: 10px" id="svg-container-top">
        <div class="col-lg-12" style="margin: unset">
            <div class="d-flex mb-3">
                <button id="open-ipath3" class="btn btn-primary mr-3">Open on iPATH3</button>
                <select id="comparison-dropdown" class="form-select" style="max-width: 200px; margin-left: 10px;"></select>
            </div>
            <div class="card">
                <h5 class="card-header">iPATH3 metabolic pathways</h5>
                <div class="card-body">
                    <div id="svg-container">
                        <!-- SVGs will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="filenames" type="application/json">
    {{
        filenames
        |
        safe
    }}
</script>

<script id="comparisons" type="application/json">
    {{
        comparisons
        |
        safe
    }}
</script>

<script id="requestBody" type="application/json">
    {{
        request_body
        |
        safe
    }}
</script>

<script type="text/javascript">
    $(document).ready(function () {
        const svgFiles = JSON.parse(document.getElementById('filenames').textContent);
        const comparisons = JSON.parse(document.getElementById('comparisons').textContent);
        const requestBody = JSON.parse(document.getElementById('requestBody').textContent);
        const svgContainer = document.getElementById('svg-container');
        const dropdown = document.getElementById('comparison-dropdown');

        // Populate dropdown with comparison names
        comparisons.forEach((comparison, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = comparison;
            dropdown.appendChild(option);
        });

        // Function to load SVG based on dropdown selection
        function loadSVG(index) {
            const file = svgFiles[index];
            fetch(file)
                .then(response => response.text())
                .then(svgText => {
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
                    const svgElement = svgDoc.querySelector("svg");
                    svgContainer.innerHTML = ''; // Clear previous SVG
                    svgContainer.appendChild(svgElement);
                });
        }

        // Load the first SVG by default
        loadSVG(0);

        // Change event for dropdown
        dropdown.addEventListener('change', function() {
            loadSVG(this.value);
        });

        // Add event listener for the button
        document.getElementById('open-ipath3').addEventListener('click', function() {
            const selectedComparison = comparisons[dropdown.value];
            const params = requestBody[selectedComparison];

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://pathways.embl.de/ipath3.cgi';
            form.target = '_blank'; // Open in a new window

            // Add each key-value pair as a hidden input
            for (const [key, value] of Object.entries(params)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        });
    });
</script>

{% endblock %}

{% block footer %}
{% set loading_selector = '#loading' %}
{% include 'js-error-handler.html' %}
{% endblock %}
