<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genome Visualization with Contigs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        .genome-contig { cursor: pointer; }
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #chart-container {
            height: 50vh;
            overflow-y: auto;
        }
        #chart {
            width: 100%;
        }
        #circular-view {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .offcanvas-bottom {
            height: 50vh !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">Genome Visualization</h1>
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Controls</h5>
                        <div class="mb-3">
                            <label for="metric-select" class="form-label">Color main view by:</label>
                            <select id="metric-select" class="form-select">
                                <option value="gcContent">GC Content</option>
                                <option value="coverageDepth">Coverage Depth</option>
                                <option value="expressionLevel">Expression Level</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Linear Genome View</h5>
                        <div id="chart-container" style="height: 500px; overflow-y: auto;">
                            <div id="chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Offcanvas -->
    <div class="offcanvas offcanvas-bottom" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="detailsOffcanvas" aria-labelledby="detailsOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="detailsOffcanvasLabel">Genome Details</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <h5 id="details-title"></h5>
            <div id="circular-view"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sample data with contigs
        // Sample data with more contigs
        const genomes = generateGenomes(150);

        // Set up SVG
        const width = d3.select("#chart-container").node().getBoundingClientRect().width;
        const height = genomes.length * 30; // Adjust this multiplier as needed
        const margin = { top: 20, right: 20, bottom: 100, left: 100 };

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // Create scales
        const xScale = d3.scaleLinear()
            .domain([0, d3.max(genomes, g => d3.sum(g.contigs, c => c.length))])
            .range([margin.left, width - margin.right]);

        const yScale = d3.scaleBand()
            .domain(genomes.map(d => d.name))
            .range([margin.top, height - margin.bottom - 60])
            .padding(0.65);

        const colorScales = {
            gcContent: d3.scaleSequential(d3.interpolateBlues).domain([0.4, 0.6]),
            coverageDepth: d3.scaleSequential(d3.interpolateGreens).domain([20, 40]),
            expressionLevel: d3.scaleSequential(d3.interpolateReds).domain([0, 1])
        };

        // Create tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip");

        let currentMetric = 'gcContent';

        function generateGenomes(numGenomes = 25) {
            const genomes = [];

            for (let i = 0; i < numGenomes; i++) {
                const numContigs = Math.floor(Math.random() * 50) + 5; // 5 to 20 contigs per genome
                const contigs = [];

                for (let j = 0; j < numContigs; j++) {
                    contigs.push({
                        name: `Contig ${String.fromCharCode(65 + i)}${j + 1}`,
                        length: Math.floor(Math.random() * 100000), // 500,000 to 2,500,000 bp
                        gcContent: Math.random() * 0.2 + 0.3, // 30% to 50%
                        coverageDepth: Math.floor(Math.random() * 40) + 10, // 10x to 50x
                        expressionLevel: Math.random() // 0 to 1
                    });
                }

                genomes.push({
                    id: i + 1,
                    name: `Genome ${String.fromCharCode(65 + i)}`,
                    contigs: contigs
                });
            }

            // Sort contigs for each genome by length in descending order
            genomes.forEach(genome => {
                genome.contigs.sort((a, b) => b.length - a.length);
            });

            return genomes;
        }

        // Function to update the visualization
        function updateVisualization(metric) {
            currentMetric = metric;

            // Clear existing content
            svg.selectAll("*").remove();

            // Update SVG height based on the number of genomes
            const svgHeight = Math.max(genomes.length * 30, document.getElementById('chart-container').offsetHeight);
            svg.attr("height", svgHeight);

            // Update y scale
            yScale.range([margin.top, svgHeight - margin.bottom]);

            // Create a group for each genome
            const genomeGroups = svg.selectAll(".genome-group")
                .data(genomes)
                .enter()
                .append("g")
                .attr("class", "genome-group")
                .attr("transform", d => `translate(0, ${yScale(d.name)})`);

            genomeGroups.each(function(genome) {
                const group = d3.select(this);
                let startX = margin.left;

                group.selectAll(".genome-contig")
                    .data(genome.contigs)
                    .enter()
                    .append("rect")
                    .attr("class", "genome-contig")
                    .attr("x", (d, i) => {
                        const x = startX;
                        startX += xScale(d.length) - xScale(0);
                        return x;
                    })
                    .attr("y", 0)
                    .attr("width", d => xScale(d.length) - xScale(0))
                    .attr("height", yScale.bandwidth())
                    .attr("fill", d => colorScales[metric](d[metric]))
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .on("mouseover", function(event, d) {
                        showTooltip(event, genome, d);
                    })
                    .on("mouseout", function() {
                        tooltip.style("opacity", 0);
                    })
                    .on("click", function(event, d) {
                        showDetails(genome);
                    });

                // Add genome name
                group.append("text")
                    .attr("class", "genome-name")
                    .attr("x", margin.left - 10)
                    .attr("y", yScale.bandwidth() / 2)
                    .attr("text-anchor", "end")
                    .attr("dominant-baseline", "middle")
                    .text(genome.name);
            });

            // Update legend
            updateLegend(metric);
        }

        function showTooltip(event, genome, contig) {
            tooltip.style("opacity", 1)
                .html(`<strong>${genome.name}</strong><br/>
                       Length: ${contig.length.toLocaleString()} bp<br/>
                       GC Content: ${(contig.gcContent * 100).toFixed(2)}%<br/>
                       Coverage Depth: ${contig.coverageDepth}x<br/>
                       Expression Level: ${contig.expressionLevel.toFixed(2)}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        // Add genome names
        svg.selectAll(".genome-name")
            .data(genomes)
            .enter()
            .append("text")
            .attr("class", "genome-name")
            .attr("x", margin.left - 10)
            .attr("y", d => yScale(d.name) + yScale.bandwidth() / 2)
            .attr("text-anchor", "end")
            .attr("dominant-baseline", "middle")
            .text(d => d.name);

        // Function to update legend
        function updateLegend(metric) {
            const legendWidth = 300;
            const legendHeight = 20;

            svg.select(".legend").remove();

            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${(width - legendWidth) / 2}, ${height - margin.bottom + 20})`);

            const legendScale = d3.scaleLinear()
                .domain(colorScales[metric].domain())
                .range([0, legendWidth]);

            const legendAxis = d3.axisBottom(legendScale)
                .tickFormat(d => metric === 'gcContent' ? d3.format(".0%")(d) : d3.format(".2f")(d));

            const legendGradient = legend.append("defs")
                .append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%");

            legendGradient.selectAll("stop")
                .data(colorScales[metric].ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: colorScales[metric](t) })))
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);

            legend.append("rect")
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#legend-gradient)");

            legend.append("g")
                .attr("transform", `translate(0, ${legendHeight})`)
                .call(legendAxis);

            legend.append("text")
                .attr("x", legendWidth / 2)
                .attr("y", 50)
                .attr("text-anchor", "middle")
                .text(metric === 'gcContent' ? "GC Content" : (metric === 'coverageDepth' ? "Coverage Depth" : "Expression Level"));
        }

        // Function to show details
        function showDetails(genome) {
            // Create and show the offcanvas
            const offcanvasElement = document.getElementById('detailsOffcanvas');
            const offcanvas = new bootstrap.Offcanvas(offcanvasElement);
            offcanvas.show();

            d3.select("#details-title").text(genome.name);

            const detailsSvg = d3.select("#circular-view");
            detailsSvg.selectAll("*").remove();

            const containerRect = detailsSvg.node().getBoundingClientRect();
            const size = Math.min(containerRect.width, containerRect.height, 600); // Limit max size to 600px or container size

            const svg = detailsSvg
                .append("svg")
                .attr("width", size)
                .attr("height", size)
                .style("display", "block")
                .style("margin", "auto");

            const width = size;
            const height = size;
            const radius = Math.min(width, height) / 2 * 0.9; // Reduce radius to make room for legend

            const metrics = ['gcContent', 'coverageDepth', 'expressionLevel'];
            const innerRadiusRatio = 0.6;
            const outerRadiusRatio = 0.9;
            const radiusStep = (outerRadiusRatio - innerRadiusRatio) / metrics.length;
            const ringPadding = 0.02;

            const arcPadAngle = 0.02;

            const pie = d3.pie()
                .sort(null)
                .value(d => d.length)
                .padAngle(arcPadAngle);

            const g = svg.append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2 - height * 0.05})`);  // Move circle up slightly

            metrics.forEach((metric, index) => {
                const arc = d3.arc()
                    .innerRadius(radius * (innerRadiusRatio + index * radiusStep + ringPadding / 2))
                    .outerRadius(radius * (innerRadiusRatio + (index + 1) * radiusStep - ringPadding / 2))
                    .cornerRadius(2);

                const arcs = g.selectAll(`.arc-${metric}`)
                    .data(pie(genome.contigs))
                    .enter().append("path")
                    .attr("class", `arc-${metric}`)
                    .attr("d", arc)
                    .attr("fill", d => colorScales[metric](d.data[metric]))
                    .on("mouseover", function(event, d) {
                        showDetailTooltip(event, d.data);
                    })
                    .on("mouseout", function() {
                        tooltip.style("opacity", 0);
                    });
            });

            // Add color-coded legend at the bottom
            const legendData = [
                { metric: "gcContent", label: "GC Content", color: colorScales.gcContent(0.5) },
                { metric: "coverageDepth", label: "Coverage Depth", color: colorScales.coverageDepth(30) },
                { metric: "expressionLevel", label: "Expression Level", color: colorScales.expressionLevel(0.5) }
            ];

            const legendHeight = 60;
            const legend = svg.append("g")
                .attr("transform", `translate(0, ${height - legendHeight})`);

            const legendItemWidth = width / legendData.length;

            const legendItems = legend.selectAll(".legend-item")
                .data(legendData)
                .enter().append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(${i * legendItemWidth}, 0)`);

            legendItems.append("rect")
                .attr("width", 15)
                .attr("height", 15)
                .attr("x", legendItemWidth / 2 - 7.5)
                .attr("y", 0)
                .attr("fill", d => d.color);

            legendItems.append("text")
                .attr("x", legendItemWidth / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => d.label);
        }

        function showDetailTooltip(event, contig) {
            tooltip.style("opacity", 1)
                .html(`<strong>${contig.name}</strong><br/>
                       Length: ${contig.length.toLocaleString()} bp<br/>
                       GC Content: ${(contig.gcContent * 100).toFixed(2)}%<br/>
                       Coverage Depth: ${contig.coverageDepth}x<br/>
                       Expression Level: ${contig.expressionLevel.toFixed(2)}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        // Adjust the chart height when the window is resized
        window.addEventListener('resize', function() {
            // const chartContainer = document.getElementById('chart-container');
            // const chart = d3.select("#chart");
            // chart.attr("height", chartContainer.offsetHeight);
            updateVisualization(currentMetric);
        });

        // Initial call to set the correct height
        window.dispatchEvent(new Event('resize'));

        // Redraw circular view when offcanvas is shown (in case of window resize)
        // document.getElementById('detailsOffcanvas').addEventListener('shown.bs.offcanvas', function () {
        //     const currentGenome = d3.select("#details-title").text();
        //     const genome = genomes.find(g => g.name === currentGenome);
        //     if (genome) {
        //         showDetails(genome);
        //     }
        // });

        // Initial visualization
        updateVisualization('gcContent');
        showDetails(genomes[0]);  // Show first genome by default

        // Add event listener for dropdown
        d3.select("#metric-select").on("change", function() {
            updateVisualization(this.value);
        });
    </script>
</body>
</html>